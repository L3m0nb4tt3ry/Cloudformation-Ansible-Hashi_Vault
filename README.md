# Cloudformation-Ansible-Hashi_Vault
Create cloudformation template using ansible and Hashi vault roles

Warning: This set up is for demo purpose do not use this setup in production.
---
Pre-requisites
---

[Ansible](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html)

[HashiVault](https://www.vaultproject.io/downloads.html)

Set up Hashi_vault:
```
$ vault server -dev
```
Take a note of root token generated by above command. We will need this token to authenticate vault
```
$ export VAULT_ADDR=http://127.0.0.1:8200
```
Check is vault is properly working 
```
$ vault status
```
Configure vault to store aws credentials
```
$ vault secrets enable -path=aws aws

$ vault write aws/config/root     access_key=AABCDXXXXX     secret_key=abcdxxxxxx
$ vault write aws/roles/deploy \
    arn=arn:aws:iam::ACCOUNT-ID-WITHOUT-HYPHENS:role/RoleNameToAssume
```
Clone the repo
```
$ git clone https://github.com/L3m0nb4tt3ry/Cloudformation-Ansible-Hashi_Vault.git
$ cd Cloudformation-Ansible_Hashi_Vault
$ ansible-playbook -i inventory -K cisplaybook.yml --extra-vars "vault_token=ROOT_TOKEN"
```
Ansible will create a cloudformation stack with cis_audit lambda function.

Future Scope:
- Execute lambda function from same ansible playbook
- Run CIS_FIX script from playbook

Extras:
Please check Hashi Vaults docucmentation regarding IAM policies and assume roles. [Link](https://www.vaultproject.io/docs/secrets/aws/index.html)

The aws/config/root credentials need permission to manage dynamic IAM users. Here is an example AWS IAM policy that grants the most commonly required permissions Vault needs:
 ```
 {
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "iam:AttachUserPolicy",
        "iam:CreateAccessKey",
        "iam:CreateUser",
        "iam:DeleteAccessKey",
        "iam:DeleteUser",
        "iam:DeleteUserPolicy",
        "iam:DetachUserPolicy",
        "iam:ListAccessKeys",
        "iam:ListAttachedUserPolicies",
        "iam:ListGroupsForUser",
        "iam:ListUserPolicies",
        "iam:PutUserPolicy",
        "iam:RemoveUserFromGroup"
      ],
      "Resource": [
        "arn:aws:iam::ACCOUNT-ID-WITHOUT-HYPHENS:user/vault-*"
      ]
    }
  ]
}
```
The aws/config/root credentials require IAM permissions for sts:GetFederationToken and the permissions to delegate to the STS federation token. For example, this policy on the aws/config/root credentials would allow creation of an STS federated token with delegated ec2:* permissions:
```
$ cat policy.json
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Action": [
      "ec2:*",
      "sts:GetFederationToken"
    ],
    "Resource": "*"
  }
}
$ vault write aws/roles/deploy \
    policy=@policy.json
```
